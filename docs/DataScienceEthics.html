<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Uras Uyal">
<meta name="dcterms.date" content="2025-04-16">
<meta name="description" content="A piece on the question of ethics for and the intented or unintended consequences of AI facial recognition being used commercially">

<title>Facial Recognition and Data Ethics Problems – Uras Uyal</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Uras Uyal</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-data-viz" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Data Viz</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-data-viz">    
        <li>
    <a class="dropdown-item" href="./SpaceObjects.html">
 <span class="dropdown-text">Space Objects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./IDPs.html">
 <span class="dropdown-text">Internally Displaced People (IDPs)</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./SongsAnalysis.html"> 
<span class="menu-text">Songs Text Analysis</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./HomeAdvantageOlympics.html"> 
<span class="menu-text">Olympics Home Advantage</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./DataScienceEthics.html" aria-current="page"> 
<span class="menu-text">Data Science and Ethics</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#who-was-measured-are-those-individuals-representative-of-the-people-to-whom-wed-like-to-generalize-apply-the-algorithm-should-we-analyze-data-if-we-do-not-know-how-the-data-were-collected" id="toc-who-was-measured-are-those-individuals-representative-of-the-people-to-whom-wed-like-to-generalize-apply-the-algorithm-should-we-analyze-data-if-we-do-not-know-how-the-data-were-collected" class="nav-link" data-scroll-target="#who-was-measured-are-those-individuals-representative-of-the-people-to-whom-wed-like-to-generalize-apply-the-algorithm-should-we-analyze-data-if-we-do-not-know-how-the-data-were-collected">Who was measured? Are those individuals representative of the people to whom we’d like to generalize / apply the algorithm? Should we analyze data if we do not know how the data were collected?</a></li>
  <li><a href="#should-race-be-used-as-a-variable-is-it-a-proxy-for-something-else-what-about-gender" id="toc-should-race-be-used-as-a-variable-is-it-a-proxy-for-something-else-what-about-gender" class="nav-link" data-scroll-target="#should-race-be-used-as-a-variable-is-it-a-proxy-for-something-else-what-about-gender">Should race be used as a variable? Is it a proxy for something else? What about gender?</a></li>
  <li><a href="#presenting-work-in-ways-that-empower-others-to-make-better-informed-decisions" id="toc-presenting-work-in-ways-that-empower-others-to-make-better-informed-decisions" class="nav-link" data-scroll-target="#presenting-work-in-ways-that-empower-others-to-make-better-informed-decisions">Presenting work in ways that empower others to make better-informed decisions</a></li>
  <li><a href="#recognizing-and-mitigating-bias-in-ourselves-and-in-the-data-we-use" id="toc-recognizing-and-mitigating-bias-in-ourselves-and-in-the-data-we-use" class="nav-link" data-scroll-target="#recognizing-and-mitigating-bias-in-ourselves-and-in-the-data-we-use">Recognizing and mitigating bias in ourselves and in the data we use</a></li>
  <li><a href="#sources" id="toc-sources" class="nav-link" data-scroll-target="#sources">Sources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Facial Recognition and Data Ethics Problems</h1>
</div>

<div>
  <div class="description">
    <p>A piece on the question of ethics for and the intented or unintended consequences of AI facial recognition being used commercially</p>
  </div>
</div>


<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Uras Uyal </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 16, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="background" class="level1">
<h1>Background</h1>
<p>Artificial Intelligence is used in every part of our daily lives now – in circumstances in which we realize it and in those we do not. One way of rating or classifying people, often used ethically but also just as often used unethically, is via using their face, gender, and/or skin color data. Facial recognition software are used everywhere: from direct applications such as perhaps opening your phone with a Face ID or going through automatic passport check-in to modifiable applications such as your facial data being used in order to help admit you to a job or for governmental purposes. Even if the uses can be in good light and most facial classification software might try to use it in order to promote just and fair decisions, regardless, the data itself may still be unsuitable for such purposes without initial cleansing and bias considerations.</p>
<p>According to Buolamwini and Gebru’s study “Gender Shades: Intersectional Accuracy Disparities in Commercial Gender Classification”, skin and facial data is highly skewed towards those with lighter skin and significantly skewed towards those who are classified as male. Many data-users who do not realize this, or do not adjust their outcomes to this bias, even if they make their AI take decisions in good light, end up having decisions which strongly favor lighter skinned individuals or male ones. This can be either because of the abundance of those types of facial data being more abundant will make the algorithm more confident to choose them, or more importantly, since algorithms will be trained on past data, past usages per capita being more abundant for lighter skinned individuals or male individuals will make the algorithm think that it is more positive by nature to choose such individuals; amongst other reasons. This bias has huge significance in our modern day world where increasingly AI is making decisions instead of humans. Buolamwini and Gebru’s study also highlights how misclassification of racial data for computer vision can be a reason for inaccuracies in fairness, for example for mixed-race or in-between skin colors individuals, highlighting that people groups’ phenotypes can change over time and represents a broad spectrum.</p>
<p>Another study by Denise Almeida, Konstantin Shmarko, and Elizabeth Lomas compares the different actions for facial recognition software that is being taken in the UK, EU, and the US. They highlight that with COVID-19, facial recognition has multiplied in terms of importance. They state that for the EU and UK, although a facial recognition oriented privacy act does not exist, the EU’s general data protection law, the General Data Protection Regulation (GDPR) protects local or foreign companies from using EU citizens’ data in certain ways. A lot of these uses would normally be covered in a long terms of use elsewhere in the world and freely used. However, the authors still claim that these measures are not enough. On the other hand, according to the paper, a framework in the USA does not exist for facial recognition software data privacy; however, some California cities have banned the usage of any facial recognition technology and some companies like IBM and Amazon have promised and taken action to double down on not using facial recognition software for usages that may be harmed by inclusions of biases. However, when looked at the issue as a widespread problem, more actions should be taken all around the world in terms of data privacy as well. This raises questions in using such data in which where they come from or what kinds of biases they may include is or may be vague.</p>
<p>As it stands, the commercial usage of facial recognition software is a very important and relevant issue, as so many possibilities of unethical usage exist: most facial recognition data itself is skewed towards biasing males or lighter skinned people, and the sharing of this data and if there were biases inputted into the data by itself is vague. Even if someone wanted to use the data with good intentions, it is highly improbable that the data that they have is fully ethically sound.</p>
<p>Some questions or points that may come up as good discussion prompts for facial recognition AI and ethics and for Buolamwini and Gebru’s study “Gender Shades: Intersectional Accuracy Disparities in Commercial Gender Classification” are as follows:</p>
</section>
<section id="who-was-measured-are-those-individuals-representative-of-the-people-to-whom-wed-like-to-generalize-apply-the-algorithm-should-we-analyze-data-if-we-do-not-know-how-the-data-were-collected" class="level1">
<h1>Who was measured? Are those individuals representative of the people to whom we’d like to generalize / apply the algorithm? Should we analyze data if we do not know how the data were collected?</h1>
<p>Buolamwini and Gebru exactly highlight in their study that the individuals that are part of the data sets for most usages of facial recognition data are not representative of the people whom we’d like to generalize. The people whom we’d like to generalize would be the general public, with as low bias or none, if at all possible, towards any group that an individual could belong to. An ideal algorithm would look at the individual and not be biased by groups (ethnic, religious, sexual, etc.) that the individual may be part of. Instead, people who were measured were mostly lighter skinned or males. Furthermore, Denise Almeida, Konstantin Shmarko, and Elizabeth Lomas’s also touch upon how there is a lack of transparency in big facial recognition data and where it comes from, or how it is processed. If we don’t know how the data was collected, for scientific purposes, it cannot be ethical to use it. For commercial purposes, using and implementing this data would mean some people would be unfairly disadvantaged, which in that case, it is not fully ethical to use it either. The data we have for facial recognition as it currently stands is not unbiased, and Buolamwini and Gebru do a good job at pointing this out.</p>
</section>
<section id="should-race-be-used-as-a-variable-is-it-a-proxy-for-something-else-what-about-gender" class="level1">
<h1>Should race be used as a variable? Is it a proxy for something else? What about gender?</h1>
<p>The question of if race should be used as a variable is a question about affirmative action or no affirmative action. Without a doubt, affirmative action has had its benefits and also negatives. It is such an important topic and both sides of the argument are heavy. If the data will be used to judge one on solely meritocratic grounds, it may be best to not use race as a variable. However, this also depends on what you call “fair”, as people from disadvantaged groups would have a harder time getting to those meritocratic grounds anyways, as the real world is far from meritocratic. This decision would have to depend on the individual study, but, transparency is key in any usage of data. Regarding if race is a proxy for something else, Buolamwini and Gebru specifically talk about this. They say that labeling skin tones in certain ways diminishes the attention to detail we can give to perhaps skin colors that lie in-between labels as they would have to be put at one category or the other. Same with gender, they say:</p>
<blockquote class="blockquote">
<p>“All evaluated companies provided a “gender classification” feature that uses the binary sex labels of female and male. This reductionist view of gender does not adequately capture the complexities of gender or address transgender identities. The companies provide no documentation to clarify if their gender classification systems which provide sex labels are classifying gender identity or biological sex.”</p>
</blockquote>
<p>Therefore, it is not completely ethical to label pigmentation as certain classes of skin color. However, it is not feasible nor comparatively useful with current technology to not label either. Again, companies or data-users should do their best to be transparent about whatever they do. Buolamwini and Gebru say that the companies that they analyzed do not provide any documentation to clarify how gender was defined. This would be an unethical use of the data. Again, if companies are to do classifications, which is a question of ethics on their own, they must provide transparency on what those classifications are and how they are obtained and used; otherwise, their practices will lack ethical boundaries. Again, Buolamwini and Gebru do a good job at highlighting this.</p>
</section>
<section id="presenting-work-in-ways-that-empower-others-to-make-better-informed-decisions" class="level1">
<h1>Presenting work in ways that empower others to make better-informed decisions</h1>
<p>As there would be more lighter skinned individuals and males in data sets, as we know, our algorithms would be biased to pick such individuals. The presentation here is who is picked. If we are aware of the biases, and we feed that into our algorithm, perhaps it would make a better-informed decision in order to mitigate bias as much as possible. In terms of Buolamwini and Gebru’s study, they present their work very diligently, using very relevant data, and citing every other study necessary as they go on. They do this in order to publish a paper that has the exact principle of empowering others (companies, humans, or AI) to make better-informed decisions. The usage of AI for humans is truly an ethical issue. Humanity has never been fully ethical, and AI will get more powerful than humans soon. If people have an ideal of making human-sourced decisions ethically, frameworks about ethics should go hand-in-hand with the AI-processed data that they use as well, not be independent from it.</p>
</section>
<section id="recognizing-and-mitigating-bias-in-ourselves-and-in-the-data-we-use" class="level1">
<h1>Recognizing and mitigating bias in ourselves and in the data we use</h1>
<p>Recruiters for a role, per se, may also have biases without the usage of AI. Naturally, when interviewing candidates, they see the other person’s skin color. Though they may not realize it, it is possible for them to be subconsciously biased based on their previous life experiences. This is the same with AI: AI’s previous life experiences is the data that it is fed, which we have seen to be disproportionately light skinned and male filled. Buolamwini and Gebru’s study does a great job at pointing this out and helps in order to recognize this bias. People have been for a long time trying not to be biased, and although it has worked in some part, it is not perfect. Perhaps, if we train our AI in such a manner that and/or modify our data set that it is done correctly and ethically, in order to produce ethics-oriented decisions; AI facial recognition may be better at mitigating bias than us one day. However, there is a long way to get there – and this is only possible if everyone realizes that this mitigation of bias is possible if we mitigate bias in every single step: when collecting, using, modifying, training on, and reflecting upon our data and findings altogether.</p>
</section>
<section id="sources" class="level1">
<h1>Sources</h1>
<p>Almeida, D., Shmarko, K. &amp; Lomas, E. The ethics of facial recognition technologies, surveillance, and accountability in an age of artificial intelligence: a comparative analysis of US, EU, and UK regulatory frameworks. AI Ethics 2, 377–387 (2022). https://doi.org/10.1007/s43681-021-00077-w.</p>
<p>Buolamwini, J. &amp; Gebru, T.. (2018). Gender Shades: Intersectional Accuracy Disparities in Commercial Gender Classification. <i>Proceedings of the 1st Conference on Fairness, Accountability and Transparency</i>, in <i>Proceedings of Machine Learning Research</i> 81:77-91 Available from https://proceedings.mlr.press/v81/buolamwini18a.html.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>